---
title: "Module 2.1 - Correlations"
author: "A. Gamble, I. Ali, N. Zaitlen, R. Wollman"
output: 
 html_document:
 toc: TRUE
 toc_float: TRUE
---

## Setup

In today's session, we will use the `ggplot2` package for plotting.

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(ggplot2) # plotting library

```

## Data exploration

### Loading and printing the data

For this example, we are going to use the built-in Iris data set. The Iris data set was originally
collected in 1890 by Sir Ronald Aylmer Fischer, also the person who invented the Fischer's 
exact test, maximum liklihood estimation and analysis of variance tests. Use of this data set
is so common in statistical training, it has been developed into a built in package and data
set that can be easily loaded and analyzed in R.

This data set contains flower characteristics for three species of plants: setosa, virginica and 
versicolor. The characteristics include width and length characteristics of the flowers and sepals
(the leaf under the flower). In total the data set contains 150 observations of 5 variables. 

```{r data}

head(iris)

```

Below, lets start by exploring potential associations between petal length and width, and between 
sepal length and width.

### Visualizing the data

```{r visualassessment}

# use ggplot to make a histogram to view the distribution of petal.length values
ggplot(irisdata, aes(Petal.Length)) +
  geom_histogram() +
  labs(title = "Iris Data - Petals",
       x = "Petal Length",
       y = "Counts") 

# add a fill color to distinguish between species
ggplot(irisdata, aes(Petal.Length, fill = Species)) +
  geom_histogram() +
  labs(title = "Iris Data - Petals",
       x = "Petal Length",
       y = "Counts") +
  scale_fill_discrete(name = "Species", labels = c("Setosa", "Versicolor", "Virginica"))

# use ggplot to create a scatter plot comparing petal width and petal
# length for the species

# use scale_color_discreet to edit the name and labels for your legend
ggplot(irisdata, aes(x = Petal.Width, y = Petal.Length, color = Species)) +
  geom_point() +
  labs(title = "Iris Data - Petals",
       x = "Petal Width",
       y = "Petal Length") +
  scale_color_discrete(name = "Species", labels = c("Setosa", "Versicolor", "Virginica"))


```

## Testing correlations

### Pearson's correlation 

The Pearson's correlation is used to measure the strength and direction of association 
between two variables. The Pearson's correlation coefficient can be obtained using the
`cor()` function by setting to method to `pearson`.

```{r pearson-cor}

# cor() function to calculate the correlation coefficient
cor(iris$Petal.Length, iris$Petal.Width, # Variables between which we want to measure the association
    method = c("pearson") # Method
    ) 

```

Correlation coefficients can also be obtained using the `cor.test()` function, which also returns a confidence interval of the correlation coefficient. 

```{r pearson-cor.test}

# cor.test() function to calculate the correlation coefficient
# and the associated confidence interval
cor.test(iris$Petal.Length, iris$Petal.Width, # Variables between which we want to measure the association
         method = "pearson" # Method
         )

```

### Spearman's rank correlation

The Spearman's rank correlation is a non-parametric equivalent to Pearson's correlation. It is used to measure the strength and direction of association between two ranked variables. The Spearman's rank correlation coefficient can also be obtained using the `cor()` function or the `cor.test()` function by setting to method to `spearman`.

```{r spearman}

# cor() function to calculate the correlation coefficient
cor(iris$Petal.Length, iris$Petal.Width, # Variables between which we want to measure the association
    method = c("spearman") # Method
    ) 

# cor.test() function to calculate the correlation coefficient
# and the associated confidence interval
cor.test(iris$Petal.Length, iris$Petal.Width, # Variables between which we want to measure the association
         method = "spearman" # Method
         )

```

Note that, as Spearman's method is based on ranks, it cannot compute exact p-value when there are tied values (i.e., when two are more observations are equal).

### Permutations

Add explanations...

We start by writing a function that calculates the p-value and correlation coefficient using permutations. 

```{r permutations-function}

my_perm_corr_test = function(x, y, iter = 1000) {
  r_perm = array(dim = iter)
  for (i in 1:iter) { # seq(iter) same as 1:iter
    r_perm[i] = cor(x, sample(y))
  }
  r_real = cor(x, y)
  r_perm_abs = abs(r_perm)
  r_real_abs = abs(r_real)
  bigger_thans = r_real_abs > r_perm_abs
  p_grater_thans = mean(bigger_thans)
  pval = 1 - p_grater_thans
  rtn = list("r_perm" = r_perm,
             "pval" = pval,
             "r_real" = r_real)
  return(rtn)
}

```

We can now apply our `my_perm_corr_test()` to the petal data. 

```{r permutations-petals}

# Execute the my_perm_corr_test() function
prmtst = my_perm_corr_test(iris$Petal.Length, iris$Petal.Width, iter = 1000)

# Visualize the distribution of the permutations
# the output of our permutation function is not a data frame so we must
# convert it to a data frame to plot in ggplot
ggplot(data.frame(prmtst), aes(r_perm)) +
  geom_histogram()

# Print the calculated p-value and correlation coefficient
prmtst$pval
prmtst$r_real 

```

We then apply our `my_perm_corr_test()` to the sepal data. 

```{r permutations-sepals}

# Execute the my_perm_corr_test() function
prmtst = my_perm_corr_test(iris$Sepal.Length, iris$Sepal.Width, iter = 1000)

# Visualize the distribution of the permutations
ggplot(data.frame(prmtst), aes(r_perm)) +
  geom_histogram()

# Print the calculated p-value and correlation coefficient
prmtst$pval
prmtst$r_real 

```
