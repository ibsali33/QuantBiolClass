---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

Init and include libraries
```{r}
rm(list=ls())
library(ggplot2)
```


Famous Iris dataset 
```{r}
head(iris)
```

```{r}
plot(iris$Petal.Width, iris$Petal.Length, pch=21, bg=c("red","green3","blue")[unclass(iris$Species)], main="Iris Data - Petals", xlab="Petal Width", ylab="Petal Length")


qplot(iris$Petal.Length)


```


Testing correlations
```{r}
r_p=cor(iris$Petal.Length, iris$Petal.Width, method = c("pearson"))
r_p
r_s=cor(iris$Petal.Length, iris$Petal.Width, method = c("spearman"))
r_s

cor.test(iris$Petal.Length,iris$Petal.Width,method="pearson")
cor.test(iris$Petal.Length,iris$Petal.Width,method="spearman")

```

Testing with permutation
```{r}
my_perm_corr_test = function(x,y,iter=1000){
  r_perm=array(dim=iter)
  for (i in 1:iter){ # seq(iter) same as 1:iter
    r_perm[i]=cor(x,sample(y))
  }
  r_real=cor(x,y)
  r_perm_abs = abs(r_perm); 
  r_real_abs = abs(r_real); 
  bigger_thans = r_real_abs>r_perm_abs; 
  p_grater_thans = mean(bigger_thans);
  pval=1-p_grater_thans;
  rtn=list("r_perm"=r_perm,"pval"=pval,"r_real"=r_real)
  return(rtn)
}

prmtst=my_perm_corr_test(iris$Petal.Length,iris$Petal.Width,iter=1000)
hist(prmtst$r_perm)
print("corr - Petal")
prmtst$r_real
prmtst$pval

#repeat for Sepal 
prmtst=my_perm_corr_test(iris$Sepal.Length,iris$Sepal.Width)
hist(prmtst$r_perm)
print("corr - Sepal")
prmtst$r_real
prmtst$pval

```


Linear models
```{r}
#               Length = a + b* Width
olsP = lm(Petal.Length ~ Petal.Width, data=iris)
summary(olsP)

anova(olsP)
print("SSE total is just variance * df")
var(iris$Petal.Length)*(length(iris$Sepal.Length)-1)

```

Important diagnostic plots
```{r}
par(mfrow=c(2,2))
plot(olsP)
```

Bootstrap estimate of a regression coefficient
```{r}
iter=1000
SlopeBS = rep(NA,iter)
VarBS = rep(NA,iter)
for (i in 1:iter) {
  ix=sample(nrow(iris),replace=TRUE)
  irisBS=iris[ix,]
  olsBS = lm(Petal.Length ~ Petal.Width, data=irisBS)
  VarBS[i]=var(irisBS$Petal.Length)
  SlopeBS[i]=coef(olsBS)[2]
}
qplot(SlopeBS)
```

# Now for sepals
```{r}
olsS = lm(Sepal.Length ~ Sepal.Width, data=iris)
summary(olsS)

plot(iris$Sepal.Width, iris$Sepal.Length, pch=21, bg=c("red","green3","blue")[unclass(iris$Species)], main="Iris Data -  Sepal", xlab="Sepal Width", ylab="Sepal Length")
abline(olsS$coefficients, col="black")
```

# now model with species as an effect - effect specific intercept
```{r}

olsS2 = lm(Sepal.Length ~ Sepal.Width + Species-1, data=iris)
summary(olsS2)
anova(olsS2)

# Note that the -1 removes the intercept and therefore makes the other coefs easier to interpret 
olsS2_intercept = lm(Sepal.Length ~ Sepal.Width + Species, data=iris)
summary(olsS2_intercept)
anova(olsS2_intercept)
```

# Show the model
```{r}
pred = predict(olsS2) # using the model to predict Y values so we can plot them easily
lm_iris <- ggplot(data = cbind(iris,pred), mapping= aes(x= Sepal.Width, y= Sepal.Length, col=Species))
lm_iris
lm_iris1 <- lm_iris+
  geom_point() +
  geom_line(aes(y=pred)) +
  ggtitle("Sepal Length vs. Width by Species")
lm_iris1
```

But do they have the same slope? 

```{r}
olsS3 = lm(Sepal.Length ~ Sepal.Width + Species -1 + Sepal.Width:Species , data=iris)
olsS4 = lm(Sepal.Length ~ Sepal.Width + Species  + Sepal.Width:Species , data=iris)
pred = predict(olsS3)
lm_iris2 <- ggplot(data = cbind(iris,pred), mapping= aes(x= Sepal.Width, y= Sepal.Length, col=Species)) +
  geom_point() +
  geom_line(aes(y=pred)) + 
  ggtitle("Sepal Length vs. Width by Species")
lm_iris2

```

Look at parametric statistics
```{r}
summary(olsS3)
anova(olsS3)

```

we can also compare models with a call to anova
```{r}
anova(olsS3,olsS2)

```

Using AIC for model selection
```{r}
finalModel = step(lm(Sepal.Length ~ Sepal.Width * Species, data=iris))
summary(finalModel)

```



